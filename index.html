<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>부품 선택기</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 9999px; }
  .custom-scroll::-webkit-scrollbar-track { background: #18181b; }
</style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
<main class="max-w-5xl mx-auto py-10 px-4">

<section class="grid grid-cols-1 gap-3 mb-4">
  <div class="flex items-center gap-2">
    <label class="rounded-2xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 cursor-pointer">
      파일 업로드
      <input id="file-input" type="file" accept=".csv,.xlsx,.xls" class="hidden" />
    </label>
  </div>
  <div id="category-bar" class="flex items-center gap-2 overflow-x-auto custom-scroll"></div>
</section>

<section class="grid grid-cols-1 md:grid-cols-2 gap-6">

  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">부품 리스트 <span id="count" class="text-neutral-400"></span></h2>
      <button id="clear-btn" class="rounded-xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">모두 지우기</button>
    </div>
    <div class="mb-3">
      <input id="search" type="text" placeholder="부품 검색..." 
        class="w-full rounded-2xl px-4 py-2 bg-neutral-900 border border-neutral-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
    </div>
    <div id="list" class="max-h-[420px] overflow-auto pr-1 custom-scroll"></div>
  </div>

  <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg flex flex-col">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">선택된 항목</h2>
    </div>
    <div id="selected-chips" class="flex flex-wrap gap-2 mb-4 min-h-[42px]"></div>
    <div>
      <textarea id="output" readonly class="w-full h-32 mt-1 rounded-xl px-3 py-2 bg-black/60 border border-neutral-800 font-mono text-sm focus:outline-none"></textarea>
      <div class="flex items-center gap-2 mt-2">
        <button id="copy-btn" class="rounded-2xl px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">복사</button>
      </div>
    </div>
  </div>

</section>
</main>

<script>
const $ = (sel) => document.querySelector(sel);
const normKR = (s) => (s||"").normalize("NFKD").toLowerCase().replace(/\s+/g,"");

const NAME_HEADERS=["name","part","partname","item","품명","이름","부품","부품명"];
const CATEGORY_HEADERS=["category","cat","tag","tags","카테고리","분류"];

let parts=[];
let selected={};
let activeCategories=new Set(["전체"]);
let query="";

function stripBracket(name){
  const m=name.match(/^\s*\[[^\]]+\]\s*(.*)$/);
  return m ? m[1].trim() : name.trim();
}

function buildCategories(){
  const set=new Set(parts.map(p=>p.category||"기타"));
  return ["전체",...Array.from(set)];
}

function getFiltered(){
  const qn=normKR(query);
  return parts.filter(p=>{
    const catOk=activeCategories.has("전체")||activeCategories.size===0||activeCategories.has(p.category);
    const txtOk=!qn||normKR(p.name).includes(qn);
    return catOk && txtOk;
  });
}

function renderCategoryBar(){
  const bar=$("#category-bar");
  bar.innerHTML="";
  buildCategories().forEach(cat=>{
    const isActive=activeCategories.has("전체")?cat==="전체":activeCategories.has(cat);
    const btn=document.createElement("button");
    btn.textContent=cat;
    btn.className=`rounded-full px-3 py-1 border ${isActive?"bg-indigo-600 border-indigo-500":"bg-neutral-900 border-neutral-700 hover:bg-neutral-800"}`;
    btn.addEventListener("click",()=>{
      if(cat==="전체") activeCategories=new Set(["전체"]);
      else{
        if(activeCategories.has("전체")) activeCategories.delete("전체");
        activeCategories.has(cat)?activeCategories.delete(cat):activeCategories.add(cat);
        if(activeCategories.size===0) activeCategories.add("전체");
      }
      renderAll();
    });
    bar.appendChild(btn);
  });
}

function renderList(){
  const container=$("#list");
  container.innerHTML="";
  const filtered=getFiltered();
  $("#count").textContent=`(${filtered.length})`;
  if(filtered.length===0){ container.innerHTML='<div class="text-neutral-500 text-sm py-8 text-center">검색 결과가 없습니다.</div>'; return; }
  const ul=document.createElement("ul"); ul.className="space-y-2";
  filtered.forEach(p=>{
    const isChecked=selected[p.id]!=null && selected[p.id]>0;
    const qty=isChecked?selected[p.id]:1;

    const li=document.createElement("li");
    li.className=`flex items-center gap-3 bg-neutral-950 border border-neutral-800 rounded-xl p-2 ${isChecked?"ring-1 ring-indigo-500/40":""}`;

    const cb=document.createElement("input");
    cb.type="checkbox"; cb.checked=isChecked; cb.className="h-5 w-5 accent-indigo-500";
    cb.addEventListener("change",()=>{ if(cb.checked) selected[p.id]=Math.max(1,Number(qty)||1); else delete selected[p.id]; renderAll(); });

    const infoWrap=document.createElement("div"); infoWrap.className="flex-1";
    infoWrap.innerHTML=`<div class="flex items-center gap-2"><span class="text-[11px] px-2 py-0.5 rounded-full bg-neutral-800 border border-neutral-700 text-neutral-300 whitespace-nowrap">[${p.category}]</span><span class="whitespace-normal break-words">${stripBracket(p.name)}</span></div>`;

    const qtyWrap=document.createElement("div"); qtyWrap.className="flex items-center gap-2";
    const qtyLbl=document.createElement("span"); qtyLbl.className="text-sm text-neutral-400"; qtyLbl.textContent="수량";
    const qtyInp=document.createElement("input");
    qtyInp.type="number"; qtyInp.min="1"; qtyInp.value=qty; qtyInp.inputMode="numeric"; qtyInp.pattern="[0-9]*";
    qtyInp.className="w-20 rounded-xl px-3 py-1 bg-neutral-900 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500";
    qtyInp.addEventListener("input",()=>{ const val=Math.max(1,Math.floor(Number(qtyInp.value)||1)); qtyInp.value=val; selected[p.id]=val; });

    // 수량 증가/감소 버튼
    const plusBtn=document.createElement("button"); plusBtn.textContent="+"; plusBtn.className="px-2 py-1 bg-neutral-800 rounded hover:bg-neutral-700";
    plusBtn.addEventListener("click",()=>{ qtyInp.value=Number(qtyInp.value)+1; qtyInp.dispatchEvent(new Event('input')); });
    const minusBtn=document.createElement("button"); minusBtn.textContent="-"; minusBtn.className="px-2 py-1 bg-neutral-800 rounded hover:bg-neutral-700";
    minusBtn.addEventListener("click",()=>{ qtyInp.value=Math.max(1,Number(qtyInp.value)-1); qtyInp.dispatchEvent(new Event('input')); });

    qtyWrap.append(qtyLbl,qtyInp,minusBtn,plusBtn);
    li.append(cb,infoWrap,qtyWrap); ul.appendChild(li);
  });
  container.appendChild(ul);
}

function renderSelectedChips(){
  const box=$("#selected-chips"); box.innerHTML="";
  const items=parts.filter(p=>selected[p.id]);
  if(items.length===0){ box.innerHTML='<span class="text-neutral-500 text-sm">선택된 항목이 없습니다.</span>'; return; }
  items.forEach(p=>{
    const chip=document.createElement("div"); chip.className="flex items-center gap-2 bg-neutral-950 border border-neutral-800 rounded-full pl-3 pr-2 py-1";
    const span=document.createElement("span"); span.className="text-sm";
    const q=selected[p.id]; span.textContent=q===1?stripBracket(p.name):`${stripBracket(p.name)}×${q}`;
    const btn=document.createElement("button"); btn.className="rounded-full px-2 py-1 hover:bg-neutral-800"; btn.title="제거"
