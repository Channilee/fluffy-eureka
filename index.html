<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부품 선택 → 쉼표 데이터 생성기 (업로드 안정화/매핑 보강)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 9999px; }
    .custom-scroll::-webkit-scrollbar-track { background: #18181b; }
    .dropzone { border: 2px dashed #3f3f46; border-radius: 16px; }
    .dropzone.dragover { background: rgba(99,102,241,0.08); border-color: #6366f1; }
    .panel { border: 1px solid #262626; border-radius: 16px; background: #0b0b0c; }
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <main class="max-w-5xl mx-auto py-10 px-4">
    <section class="grid grid-cols-1 gap-3 mb-4">
      <div class="flex items-center gap-3 flex-wrap">
        <label class="rounded-2xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 cursor-pointer select-none">
          파일 업로드
          <input id="file-input" type="file" accept=".xlsx,.xls" class="hidden" />
        </label>
        <button id="reset-btn" class="rounded-2xl px-3 py-2 bg-neutral-900 hover:bg-neutral-800 border border-neutral-700">
          데이터 초기화
        </button>
        <span id="file-info" class="text-xs text-neutral-400">엑셀(.xlsx, .xls) 파일을 업로드하세요.</span>
      </div>

      <!-- 드래그&드롭 -->
      <div id="dropzone" class="dropzone px-4 py-6 text-sm text-neutral-400">
        파일을 이 영역으로 드래그&드롭하거나, 상단의 파일 업로드 버튼을 사용하세요.
      </div>

      <!-- 매핑 패널 -->
      <div id="mapping-panel" class="panel p-4 hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">열 매핑 설정</h3>
          <span id="mapping-hint" class="text-xs text-neutral-400"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
          <div>
            <label class="text-sm text-neutral-300">태그 열</label>
            <select id="map-tag-col" class="w-full mt-1 rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700"></select>
          </div>
          <div>
            <label class="text-sm text-neutral-300">부품명 열</label>
            <select id="map-name-col" class="w-full mt-1 rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700"></select>
          </div>
          <div class="flex items-end">
            <label class="inline-flex items-center gap-2 mt-6">
              <input id="map-has-header" type="checkbox" class="h-5 w-5 accent-indigo-500" />
              <span class="text-sm">첫 행은 헤더</span>
            </label>
          </div>
        </div>
        <div class="mt-3">
          <div class="text-sm text-neutral-400 mb-1">미리보기(최대 10행)</div>
          <div id="map-preview" class="text-sm bg-neutral-900 border border-neutral-800 rounded-xl p-3 max-h-40 overflow-auto"></div>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="map-apply" class="rounded-xl px-4 py-2 bg-indigo-600 hover:bg-indigo-500">적용하기</button>
          <button id="map-cancel" class="rounded-xl px-4 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">취소</button>
        </div>
      </div>

      <div id="category-bar" class="flex items-center gap-2 overflow-x-auto custom-scroll mt-2"></div>
      <div id="status" class="text-xs text-neutral-400"></div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 리스트 -->
      <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">
            부품 리스트 <span id="count" class="text-neutral-400"></span>
          </h2>
          <button id="clear-btn" class="rounded-xl px-3 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">
            모두 지우기
          </button>
        </div>
        <div class="mb-3">
          <input id="search" type="text" placeholder="부품 검색... (띄어쓰기 무시 검색)"
                 class="w-full rounded-2xl px-4 py-2 bg-neutral-900 border border-neutral-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div id="list" class="max-h-[420px] overflow-auto pr-1 custom-scroll"></div>
      </div>

      <!-- 선택/출력 -->
      <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">선택된 항목</h2>
        </div>
        <div id="selected-chips" class="flex flex-wrap gap-2 mb-4 min-h-[42px]"></div>
        <div>
          <textarea id="output" readonly class="w-full h-32 mt-1 rounded-xl px-3 py-2 bg-black/60 border border-neutral-800 font-mono text-sm focus:outline-none"></textarea>
          <div class="flex items-center gap-2 mt-2">
            <button id="copy-btn" class="rounded-2xl px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">복사하기</button>
          </div>
          <p class="mt-2 text-xs text-neutral-500">
            참고: 최종 출력은 내부 공백이 모두 제거됩니다. 예) "앞바퀴 타이어x2,후미등" → "앞바퀴타이어x2,후미등"
          </p>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== XLSX Fallback Loader =====
    async function ensureXLSX() {
      if (window.XLSX) return true;
      return new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = () => resolve(!!window.XLSX);
        s.onerror = () => resolve(false);
        document.head.appendChild(s);
      });
    }

    // ===== 상수 & 유틸 =====
    const STORAGE_KEY = 'gcoo.parts-selector.v4'; // v4: 업로드 안정화(헤더행/히ュー리스틱/단일열 옵션)
    const COMMON_TAG = "공용";
    const NAME_HEADERS = ["name","part","partname","item","품명","이름","부품","부품명","품목","제품명"];
    const TAG_HEADERS  = ["category","cat","tag","tags","카테고리","분류","태그"];

    const $ = (sel) => document.querySelector(sel);
    const normKR = (s) => (s || "").normalize("NFKD").toLowerCase().replace(/\s+/g, "");

    function setStatus(msg, isError=false) {
      const el = $("#status");
      el.textContent = msg || "";
      el.className = "text-xs " + (isError ? "text-red-400" : "text-neutral-400");
    }
    const colLetter = (i) => { let s = ""; i = Number(i); while (i >= 0) { s = String.fromCharCode((i % 26) + 65) + s; i = Math.floor(i / 26) - 1; } return s; };

    // [태그] 접두 제거
    function stripBracketPrefix(raw) {
      const str = String(raw ?? "").trim();
      const m = str.match(/^\s*\[[^\]]+\]\s*(.*)$/);
      return m ? (m[1] || "").trim() : str;
    }
    // 단일열 구포맷
    function parseBracketed(raw) {
      const str = String(raw ?? "").trim();
      const m = str.match(/^\s*\[([^\]]+)\]\s*(.*)$/);
      if (m) {
        const category = (m[1] || "").trim() || "기타";
        const name = stripBracketPrefix(m[2] || "");
        return { category, name };
      }
      return null;
    }
    // "과자/건강식" → ["과자","건강식"]
    function splitTags(catString) {
      const raw = String(catString ?? "").trim();
      if (!raw) return ["기타"];
      const arr = raw.split("/").map(s => s.trim()).filter(Boolean);
      return Array.from(new Set(arr));
    }

    // ===== 상태 =====
    // parts: { id, tags: string[], name, normName }
    let parts = [];
    let selected = {};            // id -> qty
    let activeCategory = null;    // 단일 선택; null이면 전체 보기
    let query = "";
    let lastFileName = "";
    let lastSheetName = "";

    // 매핑/시트 관련
    let rawRows = [];
    let headerRowIndex = 0;
    let mapState = { tagIdx: 0, nameIdx: 1, hasHeader: true };

    // ===== 로컬 스토리지 =====
    function saveState() {
      try {
        const payload = { v: 4, parts, selected, activeCategory, query, meta: { fileName: lastFileName, sheetName: lastSheetName, mapping: mapState, headerRowIndex } };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) { console.warn("상태 저장 실패:", e); }
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data || data.v !== 4 || !Array.isArray(data.parts)) return false;

        parts = data.parts.map(p => ({
          id: p.id || `${(p.name||"")}||${(Array.isArray(p.tags)?p.tags:["기타"]).slice().sort().join('/')}`,
          tags: Array.isArray(p.tags) ? p.tags : ["기타"],
          name: stripBracketPrefix(p.name || ""),
          normName: p.normName || normKR(p.name || "")
        }));
        selected = data.selected || {};
        query = data.query || "";
        activeCategory = data.activeCategory || null;
        lastFileName = data.meta?.fileName || "";
        lastSheetName = data.meta?.sheetName || "";
        mapState = data.meta?.mapping || mapState;
        headerRowIndex = Number.isInteger(data.meta?.headerRowIndex) ? data.meta.headerRowIndex : 0;
        return parts.length > 0;
      } catch (e) { console.warn("상태 로드 실패:", e); return false; }
    }
    function updateFileInfo(text) {
      const el = $("#file-info");
      if (el) el.textContent = text || "";
    }

    // ===== 태그/필터 =====
    function buildCategories() {
      const set = new Set();
      parts.forEach(p => p.tags.forEach(t => set.add(t)));
      return Array.from(set);
    }
    function getFiltered() {
      const qn = normKR(query);
      return parts.filter(p => {
        const tagOk = !activeCategory || p.tags.includes(activeCategory) || p.tags.includes(COMMON_TAG);
        const txtOk = !qn || p.normName.includes(qn);
        return tagOk && txtOk;
      });
    }

    // ===== 렌더링 =====
    function renderCategoryBar() {
      const bar = $("#category-bar");
      bar.innerHTML = "";
      if (parts.length === 0) return;
      const cats = buildCategories();
      cats.forEach(cat => {
        const isActive = activeCategory === cat;
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = `rounded-full px-3 py-1 border select-none ${isActive ? "bg-indigo-600 border-indigo-500" : "bg-neutral-900 border-neutral-700 hover:bg-neutral-800"}`;
        btn.addEventListener("click", () => {
          activeCategory = (activeCategory === cat) ? null : cat;
          saveState();
          renderCategoryBar();
          renderList();
        });
        bar.appendChild(btn);
      });
    }
    function liBaseClass(checked) {
      return `flex items-center gap-3 bg-neutral-950 border border-neutral-800 rounded-xl p-2 ${checked ? "ring-1 ring-indigo-500/40" : ""}`;
    }
    function toggleSelectionById(id, li, cb) {
      if (selected[id] && selected[id] > 0) {
        delete selected[id];
        if (li) li.className = liBaseClass(false);
        if (cb) cb.checked = false;
      } else {
        selected[id] = 1;
        if (li) li.className = liBaseClass(true);
        if (cb) cb.checked = true;
      }
      renderSelectedChips();
      renderOutput();
      saveState();
    }

    function renderList() {
      const container = $("#list");
      container.innerHTML = "";
      if (parts.length === 0) {
        const empty = document.createElement("div");
        empty.className = "text-neutral-500 text-sm py-8 text-center";
        empty.textContent = "엑셀 파일을 업로드하세요.";
        container.appendChild(empty);
        $("#count").textContent = "(0)";
        renderSelectedChips();
        renderOutput();
        return;
      }
      const filtered = getFiltered();
      $("#count").textContent = `(${filtered.length})`;
      if (filtered.length === 0) {
        const none = document.createElement("div");
        none.className = "text-neutral-500 text-sm py-8 text-center";
        none.textContent = "검색 결과가 없습니다.";
        container.appendChild(none);
        renderSelectedChips();
        renderOutput();
        return;
      }

      const ul = document.createElement("ul");
      ul.className = "space-y-2";
      filtered.forEach(p => {
        const isChecked = selected[p.id] != null && selected[p.id] > 0;
        const qty = isChecked ?
