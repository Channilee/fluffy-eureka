<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부품 선택 → 쉼표 데이터 생성기 (정비일지 모드 포함)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 9999px; }
    .custom-scroll::-webkit-scrollbar-track { background: #18181b; }
    .dropzone { border: 2px dashed #3f3f46; border-radius: 16px; }
    .dropzone.dragover { background: rgba(99,102,241,0.08); border-color: #6366f1; }
    .panel { border: 1px solid #262626; border-radius: 16px; background: #0b0b0c; }
    .btn { border-radius: 12px; padding: 8px 12px; }
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <main class="max-w-5xl mx-auto py-10 px-4">
    <!-- 상단: 업로드/초기화/퀵추가 -->
    <section class="grid grid-cols-1 gap-3 mb-4">
      <div class="flex items-center gap-3 flex-wrap">
        <label class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 cursor-pointer select-none">
          파일 업로드
          <input id="file-input" type="file" accept=".xlsx,.xls" class="hidden" />
        </label>
        <button id="reset-btn" class="btn bg-neutral-900 hover:bg-neutral-800 border border-neutral-700">
          데이터 초기화
        </button>
        <span id="file-info" class="text-xs text-neutral-400">엑셀(.xlsx, .xls) 파일을 업로드하세요.</span>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <div class="text-sm text-neutral-300">빠른 추가(예: [공용] 브레이크와이어유지장치 또는 태그/부품명):</div>
        <input id="quick-add" type="text" class="rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700 w-72" placeholder="[공용] 브레이크와이어유지장치 또는 공용/브레이크와이어유지장치" />
        <button id="quick-add-btn" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">추가</button>
        <span class="text-xs text-neutral-500">추가 시 로컬에 저장됩니다.</span>
      </div>

      <!-- 드래그&드롭 -->
      <div id="dropzone" class="dropzone px-4 py-6 text-sm text-neutral-400">
        파일을 이 영역으로 드래그&드롭하거나, 상단의 파일 업로드 버튼을 사용하세요.
      </div>

      <!-- 매핑 패널(수동 지정) -->
      <div id="mapping-panel" class="panel p-4 hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">열 매핑 설정</h3>
          <span id="mapping-hint" class="text-xs text-neutral-400"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
          <div>
            <label class="text-sm text-neutral-300">태그 열</label>
            <select id="map-tag-col" class="w-full mt-1 rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700"></select>
          </div>
          <div>
            <label class="text-sm text-neutral-300">부품명 열</label>
            <select id="map-name-col" class="w-full mt-1 rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700"></select>
          </div>
          <div class="flex items-end">
            <label class="inline-flex items-center gap-2 mt-6">
              <input id="map-has-header" type="checkbox" class="h-5 w-5 accent-indigo-500" />
              <span class="text-sm">첫 행은 헤더</span>
            </label>
          </div>
        </div>
        <div class="mt-3">
          <div class="text-sm text-neutral-400 mb-1">미리보기(최대 10행)</div>
          <div id="map-preview" class="text-sm bg-neutral-900 border border-neutral-800 rounded-xl p-3 max-h-40 overflow-auto"></div>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="map-apply" class="btn bg-indigo-600 hover:bg-indigo-500">적용하기</button>
          <button id="map-cancel" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">취소</button>
        </div>
      </div>

      <div id="category-bar" class="flex items-center gap-2 overflow-x-auto custom-scroll mt-2"></div>
      <div id="status" class="text-xs text-neutral-400"></div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 좌: 리스트 -->
      <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">
            부품 리스트 <span id="count" class="text-neutral-400"></span>
          </h2>
          <button id="clear-btn" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">
            모두 지우기
          </button>
        </div>
        <div class="mb-3">
          <input id="search" type="text" placeholder="부품 검색... (띄어쓰기 무시 검색)"
                 class="w-full rounded-2xl px-4 py-2 bg-neutral-900 border border-neutral-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div id="list" class="max-h-[420px] overflow-auto pr-1 custom-scroll"></div>
      </div>

      <!-- 우: 선택/출력 + 정비일지 모드 -->
      <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-3 md:p-4 shadow-lg flex flex-col gap-4">
        <!-- 픽리스트 모드 출력 -->
        <div>
          <h2 class="text-lg font-semibold">선택된 항목(픽리스트 모드)</h2>
          <div id="selected-chips" class="flex flex-wrap gap-2 mb-3 min-h-[42px]"></div>
          <textarea id="output" readonly class="w-full h-24 rounded-xl px-3 py-2 bg-black/60 border border-neutral-800 font-mono text-sm focus:outline-none"></textarea>
          <div class="flex items-center gap-2 mt-2">
            <button id="copy-btn" class="btn bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">픽리스트 복사</button>
            <span class="text-xs text-neutral-500">참고: 이 모드는 내부 공백을 모두 제거합니다.</span>
          </div>
        </div>

        <hr class="border-neutral-800"/>

        <!-- 정비일지 모드 -->
        <div>
          <h2 class="text-lg font-semibold">정비일지 모드</h2>
          <!-- 헤더 -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <div>
              <label class="text-xs text-neutral-400">담당자</label>
              <input id="log-author" type="text" class="w-full rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700" placeholder="Heon" />
            </div>
            <div>
              <label class="text-xs text-neutral-400">날짜</label>
              <input id="log-date" type="text" class="w-full rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700" placeholder="12/12" />
            </div>
            <div>
              <label class="text-xs text-neutral-400">구분</label>
              <input id="log-class" type="text" class="w-full rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700" placeholder="자5" />
            </div>
            <div>
              <label class="text-xs text-neutral-400">상태</label>
              <input id="log-status" type="text" class="w-full rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700" placeholder="정비완료" />
            </div>
          </div>

          <!-- 대상 차량 관리 -->
          <div class="mt-3">
            <div class="flex items-center gap-2 flex-wrap">
              <input id="target-input" type="text" class="rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700 w-44" placeholder="차량 ID(예: 600643)" />
              <button id="target-add-btn" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">추가</button>
              <span class="text-xs text-neutral-500">여러 개면 공백/줄바꿈으로 구분해 붙여넣어도 됩니다.</span>
            </div>
            <div id="targets" class="flex flex-wrap gap-2 mt-2"></div>

            <div class="flex flex-wrap gap-2 mt-2">
              <button id="target-load-from-left" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">현재 선택 불러오기 ← 대상</button>
              <button id="target-save-overwrite" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">현재 선택을 대상에 덮어쓰기 →</button>
              <button id="target-save-merge" class="btn bg-neutral-800 hover:bg-neutral-700 border border-neutral-700">현재 선택을 대상에 합치기 →</button>
              <button id="target-clear" class="btn bg-neutral-900 hover:bg-neutral-800 border border-neutral-700">대상 선택 초기화</button>
              <button id="target-delete" class="btn bg-neutral-900 hover:bg-neutral-800 border border-neutral-700">대상 삭제</button>
            </div>
          </div>

          <!-- 정비일지 출력 -->
          <div class="mt-3">
            <textarea id="log-output" readonly class="w-full h-36 rounded-xl px-3 py-2 bg-black/60 border border-neutral-800 font-mono text-sm focus:outline-none"></textarea>
            <div class="flex items-center gap-2 mt-2">
              <button id="log-copy-btn" class="btn bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">정비일지 복사</button>
              <span class="text-xs text-neutral-500">동명이 부품(태그 다른 경우)은 자동으로 [태그] 접두를 붙여 구분합니다.</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== XLSX loader fallback =====
    async function ensureXLSX() {
      if (window.XLSX) return true;
      return new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload = () => resolve(!!window.XLSX);
        s.onerror = () => resolve(false);
        document.head.appendChild(s);
      });
    }

    // ===== 상수 & 유틸 =====
    const STORAGE_KEY = 'gcoo.parts.selector.v5'; // v5: 정비일지/퀵추가 포함
    const COMMON_TAG = "공용";
    const NAME_HEADERS = ["name","part","partname","item","품명","이름","부품","부품명","품목","제품명"];
    const TAG_HEADERS  = ["category","cat","tag","tags","카테고리","분류","태그"];

    const $ = (sel) => document.querySelector(sel);
    const normKR = (s) => (s || "").normalize("NFKD").toLowerCase().replace(/\s+/g, "");

    function setStatus(msg, isError=false) {
      const el = $("#status");
      el.textContent = msg || "";
      el.className = "text-xs " + (isError ? "text-red-400" : "text-neutral-400");
    }
    const colLetter = (i) => { let s = ""; i = Number(i); while (i >= 0) { s = String.fromCharCode((i % 26) + 65) + s; i = Math.floor(i / 26) - 1; } return s; };

    function stripBracketPrefix(raw) {
      const str = String(raw ?? "").trim();
      const m = str.match(/^\s*\[[^\]]+\]\s*(.*)$/);
      return m ? (m[1] || "").trim() : str;
    }
    function parseBracketed(raw) {
      const str = String(raw ?? "").trim();
      const m = str.match(/^\s*\[([^\]]+)\]\s*(.*)$/);
      if (m) {
        const category = (m[1] || "").trim() || "기타";
        const name = stripBracketPrefix(m[2] || "");
        return { category, name };
      }
      return null;
    }
    function splitTags(catString) {
      const raw = String(catString ?? "").trim();
      if (!raw) return ["기타"];
      const arr = raw.split("/").map(s => s.trim()).filter(Boolean);
      return Array.from(new Set(arr));
    }

    // ===== 상태 =====
    // parts: { id, tags: string[], name, normName }
    let parts = [];
    let selected = {}; // 픽리스트 모드: id -> qty
    let activeCategory = null;
    let query = "";
    let lastFileName = "";
    let lastSheetName = "";

    // 정비일지 상태
    let log = {
      author: "",
      date: "",
      cls: "자5",
      status: "정비완료",
      targets: [], // [{id, selected: {id:qty}}]
      activeTarget: null // id
    };

    // ===== 저장/로드 =====
    function saveState() {
      try {
        const payload = {
          v: 5, parts, selected, activeCategory, query,
          meta: { fileName: lastFileName, sheetName: lastSheetName },
          log
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) { console.warn("상태 저장 실패:", e); }
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data || data.v !== 5 || !Array.isArray(data.parts)) return false;

        parts = data.parts.map(p => ({
          id: p.id || `${(p.name||"")}||${(Array.isArray(p.tags)?p.tags:["기타"]).slice().sort().join('/')}`,
          tags: Array.isArray(p.tags) ? p.tags : ["기타"],
          name: stripBracketPrefix(p.name || ""),
          normName: p.normName || normKR(p.name || "")
        }));
        selected = data.selected || {};
        query = data.query || "";
        activeCategory = data.activeCategory || null;
        lastFileName = data.meta?.fileName || "";
        lastSheetName = data.meta?.sheetName || "";

        // log
        if (data.log) {
          log.author = data.log.author || "";
          log.date = data.log.date || "";
          log.cls = data.log.cls || "자5";
          log.status = data.log.status || "정비완료";
          log.targets = Array.isArray(data.log.targets) ? data.log.targets.map(t => ({ id: t.id, selected: t.selected || {} })) : [];
          log.activeTarget = data.log.activeTarget || null;
        }
        // UI에 반영
        $("#log-author").value = log.author || "";
        $("#log-date").value = log.date || "";
        $("#log-class").value = log.cls || "자5";
        $("#log-status").value = log.status || "정비완료";

        return true;
      } catch (e) { console.warn("상태 로드 실패:", e); return false; }
    }

    function updateFileInfo(text) {
      const el = $("#file-info"); if (el) el.textContent = text || "";
    }

    // ===== 카테고리/필터 =====
    function buildCategories() {
      const set = new Set();
      parts.forEach(p => p.tags.forEach(t => set.add(t)));
      return Array.from(set);
    }
    function getFiltered() {
      const qn = normKR(query);
      return parts.filter(p => {
        const tagOk = !activeCategory || p.tags.includes(activeCategory) || p.tags.includes(COMMON_TAG);
        const txtOk = !qn || p.normName.includes(qn);
        return tagOk && txtOk;
      });
    }

    // ===== 렌더 =====
    function renderCategoryBar() {
      const bar = $("#category-bar");
      bar.innerHTML = "";
      if (parts.length === 0) return;
      const cats = buildCategories();
      cats.forEach(cat => {
        const isActive = activeCategory === cat;
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = `rounded-full px-3 py-1 border select-none ${isActive ? "bg-indigo-600 border-indigo-500" : "bg-neutral-900 border-neutral-700 hover:bg-neutral-800"}`;
        btn.addEventListener("click", () => {
          activeCategory = (activeCategory === cat) ? null : cat;
          saveState();
          renderCategoryBar();
          renderList();
        });
        bar.appendChild(btn);
      });
    }
    function liBaseClass(checked) {
      return `flex items-center gap-3 bg-neutral-950 border border-neutral-800 rounded-xl p-2 ${checked ? "ring-1 ring-indigo-500/40" : ""}`;
    }
    function toggleSelectionById(id, li, cb) {
      if (selected[id] && selected[id] > 0) {
        delete selected[id];
        if (li) li.className = liBaseClass(false);
        if (cb) cb.checked = false;
      } else {
        selected[id] = 1;
        if (li) li.className = liBaseClass(true);
        if (cb) cb.checked = true;
      }
      renderSelectedChips();
      renderOutput();
      saveState();
    }

    function renderList() {
      const container = $("#list");
      container.innerHTML = "";

      if (parts.length === 0) {
        const empty = document.createElement("div");
        empty.className = "text-neutral-500 text-sm py-8 text-center";
        empty.textContent = "엑셀 파일을 업로드하세요.";
        container.appendChild(empty);
        $("#count").textContent = "(0)";
        renderSelectedChips(); renderOutput(); renderTargets(); renderLogOutput();
        return;
      }

      const filtered = getFiltered();
      $("#count").textContent = `(${filtered.length})`;

      if (filtered.length === 0) {
        const none = document.createElement("div");
        none.className = "text-neutral-500 text-sm py-8 text-center";
        none.textContent = "검색 결과가 없습니다.";
        container.appendChild(none);
        renderSelectedChips(); renderOutput(); renderTargets(); renderLogOutput();
        return;
      }

      const ul = document.createElement("ul");
      ul.className = "space-y-2";

      filtered.forEach(p => {
        const isChecked = selected[p.id] != null && selected[p.id] > 0;
        const qty = isChecked ? selected[p.id] : 1;

        const li = document.createElement("li");
        li.className = liBaseClass(isChecked);

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = isChecked;
        cb.className = "h-8 w-8 accent-indigo-500";
        cb.setAttribute("aria-label", "선택");
        cb.addEventListener("change", () => {
          if (cb.checked) selected[p.id] = Math.max(1, Number(qty) || 1);
          else delete selected[p.id];
          li.className = liBaseClass(cb.checked);
          renderSelectedChips(); renderOutput(); renderLogOutput();
          saveState();
        });

        const infoWrap = document.createElement("div");
        infoWrap.className = "flex-1 cursor-pointer select-none";
        const infoInner = document.createElement("div");
        infoInner.className = "flex items-center gap-2 flex-wrap";

        p.tags.forEach(t => {
          const tagChip = document.createElement("span");
          tagChip.className = "text-[11px] px-2 py-0.5 rounded-full bg-neutral-800 border border-neutral-700 text-neutral-300 whitespace-nowrap";
          tagChip.textContent = `[${t}]`;
          infoInner.appendChild(tagChip);
        });

        const nameSpan = document.createElement("span");
        nameSpan.className = "whitespace-normal break-words";
        nameSpan.textContent = p.name;
        infoInner.appendChild(nameSpan);

        infoWrap.addEventListener("click", () => { toggleSelectionById(p.id, li, cb); });
        infoWrap.appendChild(infoInner);

        const qtyWrap = document.createElement("div");
        qtyWrap.className = "flex items-center gap-2";
        const qtyLbl = document.createElement("span");
        qtyLbl.className = "text-sm text-neutral-400";
        qtyLbl.textContent = "수량";

        const qtyInp = document.createElement("input");
        qtyInp.type = "number"; qtyInp.min = "1"; qtyInp.value = String(qty);
        qtyInp.inputMode = "numeric"; qtyInp.pattern = "[0-9]*";
        qtyInp.className = "w-20 rounded-xl px-3 py-1 bg-neutral-900 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500";
        const setQty = (val) => {
          const v = Math.max(1, Math.floor(Number(val) || 1));
          qtyInp.value = String(v);
          selected[p.id] = v;
          if (!cb.checked) cb.checked = true;
          li.className = liBaseClass(true);
          renderSelectedChips(); renderOutput(); renderLogOutput();
          saveState();
        };
        qtyInp.addEventListener("input", () => setQty(qtyInp.value));

        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+";
        plusBtn.className = "px-4 py-2 bg-neutral-800 rounded-lg hover:bg-neutral-700 text-2xl";
        plusBtn.setAttribute("aria-label", "수량 증가");
        plusBtn.addEventListener("click", () => setQty(Number(qtyInp.value) + 1));

        const minusBtn = document.createElement("button");
        minusBtn.textContent = "−";
        minusBtn.className = "px-4 py-2 bg-neutral-800 rounded-lg hover:bg-neutral-700 text-2xl";
        minusBtn.setAttribute("aria-label", "수량 감소");
        minusBtn.addEventListener("click", () => setQty(Math.max(1, Number(qtyInp.value) - 1)));

        qtyWrap.append(qtyLbl, qtyInp, plusBtn, minusBtn);
        li.append(cb, infoWrap, qtyWrap);
        ul.appendChild(li);
      });

      container.appendChild(ul);
      renderSelectedChips(); renderOutput(); renderTargets(); renderLogOutput();
    }

    function renderSelectedChips() {
      const box = $("#selected-chips");
      box.innerHTML = "";
      const items = parts.filter(p => selected[p.id] && selected[p.id] > 0);
      if (items.length === 0) {
        const span = document.createElement("span");
        span.className = "text-neutral-500 text-sm";
        span.textContent = "선택된 항목이 없습니다.";
        box.appendChild(span);
        return;
      }
      items.forEach(p => {
        const chip = document.createElement("div");
        chip.className = "flex items-center gap-2 bg-neutral-950 border border-neutral-800 rounded-full pl-3 pr-2 py-1";
        const label = document.createElement("span");
        label.className = "text-sm";
        const q = selected[p.id];
        label.textContent = q === 1 ? p.name : `${p.name}×${q}`;
        const btn = document.createElement("button");
        btn.className = "rounded-full px-2 py-1 hover:bg-neutral-800";
        btn.title = "제거";
        btn.textContent = "✕";
        btn.addEventListener("click", () => {
          delete selected[p.id];
          saveState();
          renderList(); renderSelectedChips(); renderOutput(); renderLogOutput();
        });
        chip.append(label, btn);
        box.appendChild(chip);
      });
    }

    // 픽리스트 출력: 내부 공백 완전 제거
    function renderOutput() {
      const out = $("#output");
      const items = parts
        .filter(p => selected[p.id] && selected[p.id] > 0)
        .map(p => {
          const q = selected[p.id];
          return q === 1 ? `${p.name}` : `${p.name}x${q}`;
        });
      out.value = items.join(",").replace(/\s+/g, "");
      $("#copy-btn").disabled = out.value.length === 0;
    }

    // ===== 정비일지: 대상/출력 =====
    function findTarget(id) {
      return log.targets.find(t => t.id === id) || null;
    }
    function ensureTarget(id) {
      let t = findTarget(id);
      if (!t) { t = { id, selected: {} }; log.targets.push(t); }
      return t;
    }
    function renderTargets() {
      const wrap = $("#targets");
      wrap.innerHTML = "";
      if (!log.targets.length) {
        const span = document.createElement("span");
        span.className = "text-neutral-500 text-sm";
        span.textContent = "대상을 추가하세요.";
        wrap.appendChild(span);
        return;
      }
      // 정렬(숫자 인식)
      const sorted = [...log.targets].sort((a,b) => {
        const na = Number(a.id), nb = Number(b.id);
        if (!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
        return String(a.id).localeCompare(String(b.id), 'ko');
      });
      sorted.forEach(t => {
        const cnt = Object.values(t.selected || {}).reduce((s,v)=>s+(Number(v)||0),0);
        const isActive = log.activeTarget === t.id;
        const btn = document.createElement("button");
        btn.className = `rounded-full px-3 py-1 border ${isActive ? "bg-indigo-600 border-indigo-500" : "bg-neutral-900 border-neutral-700 hover:bg-neutral-800"}`;
        btn.textContent = `${t.id}${cnt?`(${cnt})`:""}`;
        btn.addEventListener("click", ()=>{
          log.activeTarget = (log.activeTarget === t.id ? null : t.id);
          saveState(); renderTargets(); renderLogOutput();
        });
        wrap.appendChild(btn);
      });
    }

    function buildAmbiguityIndexForItems(items) {
      const nameToTagSig = new Map(); // nameKey -> Set(tagSig)
      items.forEach(it => {
        const p = parts.find(x => x.id === it.id);
        if (!p) return;
        const nameKey = (p.name || "").replace(/\s+/g, "").toLowerCase();
        const sig = p.tags.slice().sort().join("/");
        if (!nameToTagSig.has(nameKey)) nameToTagSig.set(nameKey, new Set());
        nameToTagSig.get(nameKey).add(sig);
      });
      const amb = new Map();
      for (const [k,set] of nameToTagSig.entries()) amb.set(k, set.size > 1);
      return amb;
    }
    function decideHeaderForDisplay(p) {
      if (activeCategory && p.tags.includes(activeCategory)) return activeCategory;
      if (p.tags.length === 1) return p.tags[0];
      return p.tags.join('/');
    }

    function renderLogOutput() {
      // 헤더
      const hdrAuthor = ($("#log-author").value || "").trim();
      const hdrDate   = ($("#log-date").value   || "").trim();
      const hdrClass  = ($("#log-class").value  || "자5").trim();
      const hdrStatus = ($("#log-status").value || "정비완료").trim();
      const headerLine = `${hdrAuthor ? hdrAuthor + ". " : ""}${hdrDate} ${hdrClass} ${hdrStatus}`.trim();

      // 각 대상 라인
      const lines = [];
      const sortedTargets = [...log.targets].sort((a,b)=>{
        const na = Number(a.id), nb = Number(b.id);
        if (!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
        return String(a.id).localeCompare(String(b.id), 'ko');
      });

      sortedTargets.forEach(t => {
        const entries = Object.entries(t.selected || {}).filter(([,q]) => Number(q) > 0);
        if (!entries.length) return;
        // 대상 내 선택 목록 → 아이템 배열
        const items = entries.map(([id,qty]) => ({ id, qty: Number(qty) }));
        const ambiguity = buildAmbiguityIndexForItems(items);

        // 라벨별 합산(같은 [태그]+이름은 합산)
        const agg = new Map(); // label -> qty
        items.forEach(it => {
          const p = parts.find(x => x.id === it.id);
          if (!p) return;
          const nameKey = (p.name || "").replace(/\s+/g, "").toLowerCase();
          const needHeader = ambiguity.get(nameKey);
          const header = needHeader ? `[${decideHeaderForDisplay(p)}]` : "";
          const label = `${header}${p.name}`;
          agg.set(label, (agg.get(label) || 0) + it.qty);
        });

        const tokens = [];
        for (const [label, qty] of agg.entries()) {
          tokens.push(qty === 1 ? label : `${label}x${qty}`);
        }
        const line = `${t.id} ${tokens.join(",")}`;
        lines.push(line);
      });

      const out = $("#log-output");
      out.value = (headerLine ? headerLine + "\n" : "") + lines.join("\n");
      $("#log-copy-btn").disabled = out.value.trim().length === 0;
    }

    // ===== 파서/매핑 =====
    function pickFirstNonEmptySheet(wb) {
      for (const name of wb.SheetNames) {
        const ws = wb.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });
        const hasData = Array.isArray(rows) && rows.some(r => Array.isArray(r) && r.some(c => String(c ?? "").trim() !== ""));
        if (hasData) return { ws, rows, sheetName: name };
      }
      return { ws: null, rows: [], sheetName: "" };
    }
    function suggestMapping(rows) {
      const header = (rows[0] || []).map(v => String(v ?? "").trim());
      const lower = header.map(v => v.toLowerCase());
      let tagIdx = -1, nameIdx = -1;
      for (let i = 0; i < lower.length; i++) {
        if (tagIdx === -1 && TAG_HEADERS.includes(lower[i])) tagIdx = i;
        if (nameIdx === -1 && NAME_HEADERS.includes(lower[i])) nameIdx = i;
      }
      let hasHeader = (tagIdx !== -1 || nameIdx !== -1);
      const colMax = Math.max(header.length, ...rows.slice(0, 200).map(r => Array.isArray(r) ? r.length : 0));
      if (tagIdx === -1 && nameIdx === -1 && colMax >= 2) {
        tagIdx = 0; nameIdx = 1; hasHeader = false;
      } else {
        if (tagIdx === -1 && nameIdx !== -1) tagIdx = (nameIdx === 0 ? 1 : 0);
        if (nameIdx === -1 && tagIdx !== -1) nameIdx = (tagIdx === 0 ? 1 : 0);
        if (tagIdx === nameIdx) {
          for (let i = 0; i < colMax; i++) { if (i !== tagIdx) { nameIdx = i; break; } }
        }
      }
      return { tagIdx, nameIdx, hasHeader, colMax };
    }
    function parseRows(rows, tagIdx, nameIdx, hasHeader) {
      const start = hasHeader ? 1 : 0;
      const parsed = [];
      let skipped = 0;
      for (let r = start; r < rows.length; r++) {
        const row = rows[r] || [];
        let cat = tagIdx >= 0 ? String(row[tagIdx] ?? "").trim() : "";
        let nameRaw = String(row[nameIdx] ?? "").trim();
        if (!cat && !nameRaw) { skipped++; continue; }
        if (!cat) {
          const legacy = parseBracketed(nameRaw);
          if (legacy) { cat = legacy.category; nameRaw = legacy.name; }
        }
        const tags = splitTags(cat || "기타");
        const name = stripBracketPrefix(nameRaw);
        if (!name) { skipped++; continue; }
        const id = `${name}||${tags.slice().sort().join('/')}`;
        parsed.push({ id, tags, name, normName: normKR(name) });
      }
      return { parsed, skipped };
    }

    function showMappingPanel(rows, suggestion) {
      const panel = $("#mapping-panel");
      const tagSel = $("#map-tag-col");
      const nameSel = $("#map-name-col");
      const headerCb = $("#map-has-header");
      const preview = $("#map-preview");
      const hint = $("#mapping-hint");

      const colMax = Math.max((rows[0] || []).length, ...rows.slice(0, 200).map(r => Array.isArray(r) ? r.length : 0));
      tagSel.innerHTML = ""; nameSel.innerHTML = "";

      const noneOpt = document.createElement("option");
      noneOpt.value = "-1"; noneOpt.textContent = "없음(단일열/괄호 또는 기타)";
      tagSel.appendChild(noneOpt);

      for (let i = 0; i < colMax; i++) {
        const label = `${colLetter(i)}${(rows[0] && rows[0][i]) ? ` · ${String(rows[0][i]).trim()}` : ""}`;
        const t = document.createElement("option"); t.value = String(i); t.textContent = label; tagSel.appendChild(t);
        const n = document.createElement("option"); n.value = String(i); n.textContent = label; nameSel.appendChild(n);
      }

      tagSel.value = String(suggestion.tagIdx >= -1 ? suggestion.tagIdx : -1);
      nameSel.value = String(suggestion.nameIdx >= 0 ? suggestion.nameIdx : Math.min(1, colMax-1));
      headerCb.checked = !!suggestion.hasHeader;
      hint.textContent = `자동 제안: 태그=${suggestion.tagIdx>=0?colLetter(suggestion.tagIdx):'없음'}, 부품명=${colLetter(suggestion.nameIdx)}, 헤더=${suggestion.hasHeader ? "예" : "아니오"}`;

      const updatePreview = () => {
        const tIdx = Number(tagSel.value);
        const nIdx = Number(nameSel.value);
        const hasH = headerCb.checked;
        const start = hasH ? 1 : 0;
        const lines = [];
        for (let r = start; r < rows.length && lines.length < 10; r++) {
          const row = rows[r] || [];
          const cat = tIdx >= 0 ? String(row[tIdx] ?? "").trim() : "";
          const nmRaw = String(row[nIdx] ?? "").trim();
          const nmLegacy = !cat ? parseBracketed(nmRaw) : null;
          const tags = splitTags(nmLegacy ? nmLegacy.category : (cat || "기타"));
          const nm = stripBracketPrefix(nmLegacy ? nmLegacy.name : nmRaw);
          if (!nm && !cat) continue;
          lines.push(`[${tags.join('/')}] ${nm}`);
        }
        preview.textContent = lines.length ? lines.join("\n") : "(데이터 미리보기 없음)";
        // mapState는 저장은 하지 않지만 참고용
      };
      updatePreview();

      $("#map-apply").onclick = () => {
        const tIdx = Number(tagSel.value);
        const nIdx = Number(nameSel.value);
        const hasH = headerCb.checked;
        const { parsed, skipped } = parseRows(rows, tIdx, nIdx, hasH);
        if (parsed.length === 0) { alert("파싱 결과가 0건입니다. 열 선택과 헤더 여부를 다시 확인해주세요."); return; }
        parts = parsed; selected = {}; activeCategory = null; query = ""; $("#search").value = "";
        saveState(); renderAll();
        setStatus(`매핑 적용: 태그=${tIdx>=0?colLetter(tIdx):'없음'}, 부품명=${colLetter(nIdx)}, 헤더=${hasH ? "예" : "아니오"} | 파싱 ${parts.length}건, 스킵 ${skipped}건`, false);
        panel.classList.add("hidden");
      };
      $("#map-cancel").onclick = () => { panel.classList.add("hidden"); };
      panel.classList.remove("hidden");
    }

    // ===== 파일 업로드 =====
    async function processFile(file) {
      setStatus("");
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      if (!["xlsx", "xls"].includes(ext)) {
        setStatus("엑셀 파일만 업로드 가능합니다. (.xlsx, .xls)", true);
        alert("엑셀 파일만 업로드 가능합니다. (.xlsx, .xls)");
        return;
      }
      const ok = await ensureXLSX();
      if (!ok) { setStatus("XLSX 라이브러리를 불러오지 못했습니다.", true); alert("XLSX 라이브러리를 불러오지 못했습니다."); return; }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const wb = XLSX.read(new Uint8Array(reader.result), { type: "array" });
          const chosen = pickFirstNonEmptySheet(wb);
          if (!chosen.ws) throw new Error("모든 시트가 비어 있음");
          const rows = chosen.rows;
          lastSheetName = chosen.sheetName;

          const sug = suggestMapping(rows);
          const { parsed } = parseRows(rows, sug.tagIdx, sug.nameIdx, sug.hasHeader);

          lastFileName = file.name;
          updateFileInfo(`${file.name} • ${lastSheetName} 로드됨`);

          if (parsed.length > 0) {
            parts = parsed; selected = {}; activeCategory = null; query = ""; $("#search").value = "";
            saveState(); renderAll();
            setStatus(`자동 매핑 성공: 태그=${sug.tagIdx>=0?colLetter(sug.tagIdx):'없음'}, 부품명=${colLetter(sug.nameIdx)}, 헤더=${sug.hasHeader ? "예" : "아니오"} | 총 ${parts.length}건`, false);
            $("#mapping-panel").classList.add("hidden");
          } else {
            setStatus("자동 매핑을 수행하지 못했습니다. 상단의 '열 매핑 설정'에서 열을 선택해 주세요.", true);
            showMappingPanel(rows, sug);
          }
        } catch (err) {
          console.error(err);
          setStatus("파일을 읽는 중 문제가 발생했습니다.", true);
          alert("파일을 읽는 중 문제가 발생했습니다. 지원 형식: .xlsx / .xls");
        }
      };
      reader.onerror = () => { setStatus("파일을 읽지 못했습니다.", true); alert("파일을 읽지 못했습니다."); };
      reader.readAsArrayBuffer(file);
    }

    // ===== 이벤트 =====
    $("#search").addEventListener("input", (e) => { query = e.target.value || ""; saveState(); renderList(); });
    $("#clear-btn").addEventListener("click", () => { selected = {}; saveState(); renderList(); renderSelectedChips(); renderOutput(); renderLogOutput(); });
    $("#reset-btn").addEventListener("click", () => {
      if (!confirm("저장된 데이터(부품 목록, 선택, 정비일지)를 모두 삭제할까요?")) return;
      parts = []; selected = {}; activeCategory = null; query = "";
      lastFileName = ""; lastSheetName = "";
      log = { author: "", date: "", cls: "자5", status: "정비완료", targets: [], activeTarget: null };
      $("#log-author").value = ""; $("#log-date").value = ""; $("#log-class").value = "자5"; $("#log-status").value = "정비완료";
      $("#search").value = ""; localStorage.removeItem(STORAGE_KEY);
      updateFileInfo("엑셀(.xlsx, .xls) 파일을 업로드하세요."); setStatus(""); renderAll(); $("#mapping-panel").classList.add("hidden");
    });
    $("#copy-btn").addEventListener("click", async () => { try { await navigator.clipboard.writeText($("#output").value); alert("복사되었습니다!"); } catch (e) { alert("복사에 실패했어요. 수동으로 복사해 주세요."); } });
    $("#file-input").addEventListener("change", (e) => { const file = e.target.files && e.target.files[0]; if (!file) return; processFile(file); e.target.value = ""; });

    // 정비일지 필드
    $("#log-author").addEventListener("input", () => { log.author = $("#log-author").value; saveState(); renderLogOutput(); });
    $("#log-date").addEventListener("input", () => { log.date = $("#log-date").value; saveState(); renderLogOutput(); });
    $("#log-class").addEventListener("input", () => { log.cls = $("#log-class").value; saveState(); renderLogOutput(); });
    $("#log-status").addEventListener("input", () => { log.status = $("#log-status").value; saveState(); renderLogOutput(); });

    // 대상 관리
    function addTargetsFromInput(val) {
      const tokens = String(val || "").split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
      tokens.forEach(id => ensureTarget(id));
      if (tokens.length) log.activeTarget = tokens[tokens.length-1];
      saveState(); renderTargets(); renderLogOutput();
    }
    $("#target-add-btn").addEventListener("click", () => {
      const v = $("#target-input").value || "";
      addTargetsFromInput(v);
      $("#target-input").value = "";
    });
    $("#target-input").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); $("#target-add-btn").click(); }
    });

    // 좌측 선택 ↔ 대상 간 연동
    $("#target-load-from-left").addEventListener("click", ()=> {
      if (!log.activeTarget) { alert("먼저 대상을 선택하세요."); return; }
      const t = ensureTarget(log.activeTarget);
      // 대상 → 좌측 선택 불러오기 (현재 버튼 라벨은 반대 의미일 수 있어 두 기능 모두 제공)
      // 여기서는 대상의 선택을 좌측으로 불러옵니다.
      selected = { ...t.selected };
      saveState(); renderList(); renderSelectedChips(); renderOutput(); renderLogOutput();
    });
    $("#target-save-overwrite").addEventListener("click", ()=> {
      if (!log.activeTarget) { alert("먼저 대상을 선택하세요."); return; }
      const t = ensureTarget(log.activeTarget);
      t.selected = { ...selected };
      saveState(); renderTargets(); renderLogOutput();
      alert("현재 선택을 대상에 덮어썼습니다.");
    });
    $("#target-save-merge").addEventListener("click", ()=> {
      if (!log.activeTarget) { alert("먼저 대상을 선택하세요."); return; }
      const t = ensureTarget(log.activeTarget);
      for (const [id,qty] of Object.entries(selected)) {
        t.selected[id] = (t.selected[id] || 0) + (Number(qty)||0);
      }
      saveState(); renderTargets(); renderLogOutput();
      alert("현재 선택을 대상에 합쳤습니다.");
    });
    $("#target-clear").addEventListener("click", ()=> {
      if (!log.activeTarget) { alert("먼저 대상을 선택하세요."); return; }
      const t = ensureTarget(log.activeTarget);
      t.selected = {};
      saveState(); renderTargets(); renderLogOutput();
    });
    $("#target-delete").addEventListener("click", ()=> {
      if (!log.activeTarget) { alert("먼저 대상을 선택하세요."); return; }
      log.targets = log.targets.filter(x => x.id !== log.activeTarget);
      log.activeTarget = null;
      saveState(); renderTargets(); renderLogOutput();
    });

    $("#log-copy-btn").addEventListener("click", async ()=>{
      try { await navigator.clipboard.writeText($("#log-output").value); alert("정비일지가 복사되었습니다!"); }
      catch(e){ alert("복사에 실패했어요. 수동으로 복사해 주세요."); }
    });

    // 빠른 추가
    $("#quick-add-btn").addEventListener("click", ()=>{
      const v = ($("#quick-add").value || "").trim();
      if (!v) return;
      let tags = [], name = "";
      // [태그] 부품명
      const legacy = parseBracketed(v);
      if (legacy) { tags = splitTags(legacy.category); name = legacy.name; }
      else {
        // 태그/부품명
        const m = v.split("/");
        if (m.length >= 2) {
          tags = splitTags(m[0]);
          name = m.slice(1).join("/").trim();
        } else {
          alert("형식 예: [공용] 브레이크와이어유지장치 또는 공용/브레이크와이어유지장치");
          return;
        }
      }
      if (!name) { alert("부품명이 비어 있습니다."); return; }
      const id = `${name}||${tags.slice().sort().join('/')}`;
      if (parts.find(p => p.id === id)) { alert("이미 존재하는 부품입니다."); return; }
      parts.push({ id, tags, name, normName: normKR(name) });
      $("#quick-add").value = "";
      saveState(); renderAll();
      setStatus(`퀵 추가됨: [${tags.join('/')}] ${name}`, false);
    });

    // 드래그&드롭
    const dz = $("#dropzone");
    ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
    ["dragenter", "dragover"].forEach(evt => dz.addEventListener(evt, () => dz.classList.add("dragover")));
    ["dragleave", "drop"].forEach(evt => dz.addEventListener(evt, () => dz.classList.remove("dragover")));
    dz.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) processFile(file);
    });

    // 초기 로드
    const restored = loadState();
    if (restored) {
      const more = lastSheetName ? ` • ${lastSheetName}` : "";
      updateFileInfo(`${lastFileName ? `${lastFileName}${more} (저장됨)` : "저장된 데이터"} • 총 ${parts.length}건`);
    }
    renderAll();
    (async () => { if (!(await ensureXLSX())) { setStatus("경고: XLSX 라이브러리를 불러오지 못했습니다. 네트워크/정책 차단 가능성.", true); } })();
  </script>
</body>
</html>
